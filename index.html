<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Scanned Products</title>
  <style>
    /* Styling for products and popup */
    .container {
      padding: 20px;
      font-family: Arial, sans-serif;
    }
    #product-list .product-card {
      padding: 10px;
      margin: 5px 0;
      border: 1px solid #ccc;
      border-radius: 5px;
      cursor: pointer;
    }
    .popup-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
    }
    .popup {
      background-color: #fff;
      padding: 20px;
      border-radius: 5px;
      max-width: 400px;
      width: 90%;
    }
    .close-popup {
      cursor: pointer;
      font-size: 18px;
      float: right;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Scanned Products</h1>
    <div id="product-list">
      <!-- Product list will be populated here -->
    </div>
    <button onclick="finalizeOrder(orderData)">Finalize Order</button>
  </div>

  <!-- Popup for Product Details -->
  <div id="popup-overlay" class="popup-overlay">
    <div class="popup">
      <span class="close-popup" onclick="closePopup()">✖</span>
      <h2 id="product-name">Product Name</h2>
      <p id="product-price">Price: €0.00</p>
      <div class="section" id="allergy-info">
        <h4>Allergy Information</h4>
        <p id="allergy-text">No allergens</p>
      </div>
      <div class="section" id="alternatives-info">
        <h4>Alternative Products</h4>
        <ul id="alternatives-text">No alternatives available</ul>
      </div>
      
      <div class="section" id="sustainability-info">
        <h4>Sustainability Details</h4>
        <p id="sustainability-text">No sustainability information</p>
      </div>
    </div>
  </div>
  <script>
    // Fetch all scanned products and display them
    async function fetchAllScannedProducts() {
      try {
        const response = await fetch("https://nickvanhooff.com/DuurzameScannerApi/public/api/products-orders");
        const productsOrders = await response.json();
        const productListElement = document.getElementById("product-list");
        productListElement.innerHTML = ""; // Clear existing content
  
        if (productsOrders.length > 0) {
          productsOrders.forEach((productOrder) => {
            const listItem = document.createElement("div");
            listItem.classList.add("product-card");
            listItem.innerHTML = `<h3>${productOrder.name}</h3>`;
            listItem.onclick = () => displayProductDetails(productOrder.product.id);
            productListElement.appendChild(listItem);
          });
        }
      } catch (error) {
        console.error("Error fetching the scanned products:", error);
      }
    }
  
    // Display product details in the popup
    async function displayProductDetails(productId) {
      try {
        const response = await fetch(
          `https://nickvanhooff.com/DuurzameScannerApi/public/api/product/${productId}`
        );
        const productOrder = await response.json();
  
        // Get the product details from the response
        const productName = productOrder.name;
        const productPrice = `€${productOrder.price}`;
        const productBrand = productOrder.brand.name;
        const productCategory = productOrder.categorie.name;
  
        // Format sustainability details
        const sustainabilities = productOrder.sustainabilities
          .map(
            (s) => `
              <li>
                <strong>${s.label_name}</strong>: Eco Score - ${s.eco_score}, 
                Bio Certified - ${s.bio_certified ? "Yes" : "No"}, 
                Animal Friendly Score - ${s.animal_friendly_score}
              </li>
            `
          )
          .join("");
  
        // Format allergens information
        const allergens = productOrder.allergens
          .map(
            (a) => `
              <li>
                <strong>${a.name}</strong>: ${a.description}
              </li>
            `
          )
          .join("");
  
        // Format alternative products
        const alternatives = await Promise.all(
          productOrder.alternatives.map(async (alt) => {
            const altResponse = await fetch(
              `https://nickvanhooff.com/DuurzameScannerApi/public/api/product/${alt.alternative_product_id}`
            );
            const altProduct = await altResponse.json();
            return `
              <li>
                <strong>${altProduct.name}</strong> - ${alt.reason} 
                <br>Price: €${altProduct.price}
              </li>
            `;
          })
        );
  
        // Update the popup content
        document.getElementById('product-name').textContent = productName;
        document.getElementById('product-price').textContent = productPrice;
        document.getElementById('allergy-text').innerHTML = allergens || 'No allergens';
        document.getElementById('sustainability-text').innerHTML = sustainabilities || 'No sustainability information';
        document.getElementById('alternatives-text').innerHTML = alternatives.length > 0 ? alternatives.join("") : 'No alternatives available';
  
        document.getElementById('popup-overlay').style.display = 'flex';
      } catch (error) {
        console.error("Error fetching the product details:", error);
      }
    }
  
    // Close the popup
    function closePopup() {
      document.getElementById('popup-overlay').style.display = 'none';
    }
  
    async function finalizeOrder(orderData) {
      try {
        const response = await fetch('https://nickvanhooff.com/DuurzameScannerApi/public/api/finalize-order', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(orderData)
        });

        if (!response.ok) {
          throw new Error('Network response was not ok');
        }

        const responseData = await response.json();
        console.log('Order finalized successfully:', responseData);
      } catch (error) {
        console.error('There was a problem with the fetch operation:', error);
      }
    }

    // Example usage:
    const orderData = {
      // Populate this object with the necessary order data
    };

    // Initial render on page load
    window.onload = function() {
      fetchAllScannedProducts();
      setInterval(fetchAllScannedProducts, 3000); // Fetch every 3 seconds
    };
  </script>
</body>
</html>