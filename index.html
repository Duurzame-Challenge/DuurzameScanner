<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Scanned Products</title>
    <script>
      // Function to fetch all scanned products
      async function fetchAllScannedProducts() {
        try {
          const response = await fetch(
            "https://nickvanhooff.com/DuurzameScannerApi/public/api/products-orders"
          );
          const productsOrders = await response.json();
          if (productsOrders.length > 0) {
            const productListElement = document.getElementById("product-list");
            productListElement.innerHTML = ""; // Clear previous content
            productsOrders.forEach((productOrder, index) => {
              const listItem = document.createElement("li");
              listItem.innerText = productOrder.name;
              listItem.style.cursor = "pointer";
              listItem.onclick = () =>
                displayProductDetails(productOrder.product.id);
              productListElement.appendChild(listItem);
            });
          }
        } catch (error) {
          console.error("Error fetching the scanned products:", error);
        }
      }

      // Function to display product details
      async function displayProductDetails(productId) {
        try {
          const response = await fetch(
            `https://nickvanhooff.com/DuurzameScannerApi/public/api/product/${productId}`
          );
          const productOrder = await response.json();
          console.log(productOrder);
          const productDetailsElement =
            document.getElementById("product-details");

          // Format sustainabilities, allergens, and alternatives data
          const sustainabilities = productOrder.sustainabilities
            .map(
              (s) => `
            <li>
              <strong>${s.label_name}</strong>: Eco Score - ${s.eco_score}, Bio Certified - ${
                s.bio_certified ? "Yes" : "No"
              }, Animal Friendly Score - ${s.animal_friendly_score}
            </li>
          `
            )
            .join("");
          
          const allergens = productOrder.allergens
            .map(
              (a) => `
            <li>
              <strong>${a.name}</strong>: ${a.description}
            </li>
          `
            )
            .join("");
          
          const alternatives = productOrder.alternatives
            .map(
              (alt) => `
            <li>
              Alternative Product ID: ${alt.alternative_product_id} - ${alt.reason}
            </li>
          `
            )
            .join("");

          productDetailsElement.innerHTML = `
            <h3>${productOrder.name}</h3>
            <p>Brand: ${productOrder.brand.name}</p>
            <p>Category: ${productOrder.categorie.name}</p>
            <p>Price: â‚¬${productOrder.price}</p>
            <h4>Sustainability Details:</h4>
            <ul>${sustainabilities}</ul>
            <h4>Allergens:</h4>
            <ul>${allergens}</ul>
            <h4>Alternative Products:</h4>
            <ul>${alternatives}</ul>
          `;
        } catch (error) {
          console.error("Error fetching the product details:", error);
        }
      }

      // Function to finalize the order
      async function finalizeOrder() {
        try {
          const response = await fetch(
            "https://nickvanhooff.com/DuurzameScannerApi/public/api/finalize-order",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
            }
          );
          if (response.ok) {
            alert("Order finalized successfully!");
            // Clear the product list
            const productListElement = document.getElementById("product-list");
            productListElement.innerHTML = "";
            // Fetch all scanned products again
            fetchAllScannedProducts();
          } else {
            alert("Failed to finalize order.");
          }
        } catch (error) {
          console.error("Error finalizing the order:", error);
          alert("Error finalizing the order.");
        }
      }

      // Fetch all scanned products on page load and set interval to fetch every 3 seconds
      window.onload = function () {
        fetchAllScannedProducts();
        setInterval(fetchAllScannedProducts, 3000);
      };
    </script>
  </head>
  <body>
    <h1>Scanned Products</h1>
    <ul id="product-list"></ul>
    <h2>Product Details</h2>
    <div id="product-details">Click on a product to see details...</div>
    <button onclick="finalizeOrder()">Reken af</button>
  </body>
</html>
